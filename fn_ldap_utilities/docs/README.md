<!--
  This User README.md is generated by running:
  "resilient-sdk docgen -p fn_ldap_utilities --user-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)
-->

# **User Guide:** fn_ldap_utilities_v1.1.1

## Table of Contents
- [Key Features](#key-features)
- [Function - LDAP Utilities: Update](#function---ldap-utilities-update)
- [Function - LDAP Utilities: Add to Group(s)](#function---ldap-utilities-add-to-groups)
- [Function - LDAP Utilities: Search](#function---ldap-utilities-search)
- [Function - LDAP Utilities: Set Password](#function---ldap-utilities-set-password)
- [Function - LDAP Utilities: Toggle Access](#function---ldap-utilities-toggle-access)
- [Function - LDAP Utilities: Remove from Group(s)](#function---ldap-utilities-remove-from-groups)
- [Data Table - LDAP Computers query results](#data-table---ldap-computers-query-results)
- [Data Table - LDAP Users query results](#data-table---ldap-users-query-results)
- [Rules](#rules)

---

## Key Features
<!--
  List the Key Features of the Integration
-->
* Improved to interact with any number of ldap/AD domains.
* Added an input field in each function to set a destination domain.
* New feature in ldap_set_password, allowing auto generated password, and length setting. In addition, for security reason it is possible to not return the password.

---

## Function - LDAP Utilities: Update
<p>A function that updates the attribute of a DN with a new value</p>
<p>Supports: Active Directory and OpenLDAP </p>

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `ldap_attribute_name` | `text` | Yes | `-` | The name of the LDAP attribute |
| `ldap_attribute_values` | `text` | Yes | `"['value1', 'value2', 'value3']"` | List (as a string representation) of the new attribute values |
| `ldap_dn` | `text` | Yes | `-` | Distinguished Name of entry you want to access |
| `ldap_domain_name` | `text` | Yes | `-` | A domain name as in app.config which the ldap action is executed. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True/False,
    "domain_name": ldap_domain_name,
    "attribute_name": ldap_attribute_name,
    "attribute_values": ldap_attribute_values,
    "user_dn": ldap_dn                
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  # Once the LDAP Utilities: Search completes, get the DN of the first entry
# which will be the DN of the account you want to update. Then set
# the name of the attribute to update and list the values

inputs.ldap_domain_name = 'domain1'
inputs.ldap_dn = workflow.properties.search_output["entries"][0]["dn"]
inputs.ldap_attribute_name = "homePhone"
inputs.ldap_attribute_values = "['081111111']"
# inputs.ldap_attribute_values = "['081111111', '082222222']"
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # If the function is successful in updating the value of the attribute,
# a note is added to the incident

if (results.success):
  noteText = """<br><i style="color: #979ca3">LDAP Utilities: Update workflow <u>complete</u>:</i>
                    An LDAP Attribute has been updated
                    <b>Attribute:</b> {0}
                    <b>New Value(s):</b> {1}
                    <b>DN:</b> '{2}'""".format(results.attribute_name, results.attribute_values, results.user_dn)
  
  incident.addNote(helper.createRichText(noteText))
  ```

  </p>
  </details>

</details>

---
## Function - LDAP Utilities: Add to Group(s)
<p>A function that allows adding multiple users to multiple groups</p>
<p>Supports: Active Directory only</p>

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `ldap_domain_name` | `text` | Yes | `-` | A domain name as in app.config which the ldap action is executed. |
| `ldap_multiple_group_dn` | `text` | Yes | `"['dn=Accounts Group,dc=example,dc=com', 'dn=IT Group,dc=example,dc=com']"` | List (represented as a string) of each DN of the related groups |
| `ldap_multiple_user_dn` | `text` | Yes | `"['dn=tom smith,dc=example,dc=com', 'dn=ted smith,dc=example,dc=com']"` | List (represented as a string) of each DN of the users |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True/False,
    "domain_name": ldap_domain_name,
    "users_dn": ldap_multiple_user_dn,
    "groups_dn": ldap_multiple_group_dn
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  # Both inputs must be a string representation of a List

## Example of multiple entries
# inputs.ldap_multiple_user_dn = "['dn=user1,dc=example,dc=com', 'dn=user2,dc=example,dc=com']"
# inputs.ldap_multiple_group_dn = "['dn=Accounts Group,dc=example,dc=com', 'dn=IT Group,dc=example,dc=com']"

## Note: You can use this handy function below, then not need to worry about the inputs formatting

def into_string_list_format(entries):
  """Function that converts a list or single string into a 'string repersentation of a list'"""
  string_list_to_return = "[{0}]"
  
  # If its a string, assume its one DN, one entry
  if isinstance(entries, basestring):
    return string_list_to_return.format('"{0}"'.format(entries))
  
  # Else assume its a List, so multiple DNs, multiple entries
  else:
    entries_to_add = ""
    for e in entries:
      entries_to_add += '"{0}",'.format(e)
    return string_list_to_return.format(entries_to_add)

list_of_users_dn = ['dn=user1,dc=example,dc=com', 'dn=user2,dc=example,dc=com']

# Both inputs must be a string representation of a List
inputs.ldap_multiple_user_dn = into_string_list_format(list_of_users_dn)
inputs.ldap_multiple_group_dn = into_string_list_format('dn=Accounts Group,dc=example,dc=com')
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # If the function is successful in adding the users to said groups,
# a note is added to the incident

if (results.success):
  noteText = """<br><i style="color: #979ca3">LDAP Utilities: Add User(s) to Group(s) <u>complete</u>:</i>
                    <b>User(s):</b> {0}
                    <b>Group(s):</b> {1}""".format(results.users_dn, results.groups_dn)
  
  incident.addNote(helper.createRichText(noteText))
  ```

  </p>
  </details>

</details>

---
## Function - LDAP Utilities: Search
<p>Resilient Function to do a search or query against an LDAP server.</p>
<p>Supports: Active Directory and OpenLDAP</p>

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `ldap_domain_name` | `text` | Yes | `-` | A domain name as in app.config which the ldap action is executed. |
| `ldap_search_attributes` | `text` | No | `-` | A single attribute or a list of attributes to be returned by the LDAP search  |
| `ldap_search_base` | `text` | Yes | `-` | The base of the LDAP search request. |
| `ldap_search_filter` | `textarea` | Yes | `-` | The filter of the LDAP search request |
| `ldap_search_param` | `text` | No | `-` | Parameter used in search filter |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
                "success": True/False,
                "domain_name": ldap_domain_name,
                "entries": List of entries returned from LDAP. Each entry will always contain the DN Attribute. Each entry is a Dictionary with the Key being the Attribute and the Value being the Attributes Value. Note: Some Attribute Values can be a List. 
}
```

</p>
</details>

<details><summary>Workflows</summary>
  <p>Additional Configuration:</p>
  <p>For Workflow "Example: LDAP Utilities: Search" to display query results, users need to manually add the “LDAP Users Query results” data table to the Artifacts tab.</p>
  <p>For Workflow "Example: LDAP Utilities: Search Computer" to display query results, users need to manually add the “LDAP Computers Query results” data table to the Artifacts tab.</p>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  ##  LDAP Utilities: Search - pre-processing script ##
inputs.ldap_domain_name = 'domain1'
inputs.ldap_search_base = "dc=example,dc=com"
inputs.ldap_search_filter = "(&(objectClass=person)(|(cn=%ldap_param%)(mail=%ldap_param%)))"
inputs.ldap_search_attributes = "cn,displayName,mail,pwdLastSet,whenCreated,title,department,userAccountControl,manager,distinguishedName"
inputs.ldap_search_param = artifact.value
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  ##  LDAP Utilities: Search - post-processing script ##

#  Globals
ENTRY_TO_DATATABLE_MAP = {
    "cn": "cn",
    "displayName": "displayName",
    "mail": "email_address",
    "pwdLastSet": "password_last_set",
    "whenCreated": "when_created",
    "title": "title",
    "department": "department",
    "manager": "manager"
}


# Processing if the function is a success
if(results.success):
  for entry in results["entries"]:
    
    if entry is None:
      break
    
    else:
      # Add Row
      row = incident.addRow("ldap_users_query_results")
      
      for k in ENTRY_TO_DATATABLE_MAP:

        if entry[k] is None:
          row[ENTRY_TO_DATATABLE_MAP[k]] = "N/A"

        else:
          try:
            # if 'entry[k]' is empty
            if len(entry[k]) == 0:
              row[ENTRY_TO_DATATABLE_MAP[k]] = "N/A"
            
            # Handle for Active Directory
            elif isinstance(entry[k], unicode):
              row[ENTRY_TO_DATATABLE_MAP[k]] = entry[k]
            
            # Handle for OpenLdap
            else:
              row[ENTRY_TO_DATATABLE_MAP[k]] = entry[k][0]
          
          except IndexError:
            row[ENTRY_TO_DATATABLE_MAP[k]] = "N/A"
  ```

  </p>
  </details>

</details>

---
## Function - LDAP Utilities: Set Password
<p>A function that allows you to set a new password for an LDAP entry given the entry's DN</p>
<p>Supports: Active Directory and OpenLDAP</p>

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `ldap_dn` | `text` | Yes | `-` | Distinguished Name of entry you want to access |
| `ldap_domain_name` | `text` | Yes | `-` | A domain name as in app.config which the ldap action is executed. |
| `ldap_new_auto_password_len` | `text` | No | `-` | Lenght for auto-generated password |
| `ldap_new_password` | `text` | No | `-` | The new password you want to set for the entry. If empty will auto generate password with lenght as in ldap_new_auto_password_len (8 default) |
| `ldap_return_new_password` | `boolean` | Yes | `-` | Choose if new password is returned in results |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True/False,
    "domain_name": ldap_domain_name,
    "user_dn": ldap_dn,
    "new_password": If ldap_return_new_password was setted True, shows the password in clear text, otherwise, shows '********'
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  # Once the LDAP Utilities: Search completes, get the DN of the first entry
# which will be the DN of the account you want to set a Set a New Password for

inputs.ldap_domain_name = 'domain1'
inputs.ldap_dn = workflow.properties.search_output["entries"][0]["dn"]
inputs.ldap_new_auto_password_len = '12'
inputs.ldap_return_new_password = True
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # If the function is successful in changing the users password,
# a note is added to the incident

if (results.success):
  noteText = """<br><i style="color: #979ca3">LDAP Utilities: Set Password workflow <u>complete</u>:</i>
                    A New Password has been set for:
                    <b>Email:</b> <u style="color: #7fb0ff">{0}</u>
                    <b>DN:</b> '{1}'
                    <b>New password:</b> '{2}'""".format(artifact.value, results.user_dn, results.new_password)
  
  incident.addNote(helper.createRichText(noteText))
  ```

  </p>
  </details>

</details>

---
## Function - LDAP Utilities: Toggle Access
<p>A function that allows an LDAP user, with the correct privileges to enable or disable another account given their DN</p>
<p>Supports: Active Directory only </p>

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `ldap_dn` | `text` | Yes | `-` | Distinguished Name of entry you want to access |
| `ldap_domain_name` | `text` | Yes | `-` | A domain name as in app.config which the ldap action is executed. |
| `ldap_toggle_access` | `select` | Yes | `-` | Either enable or disable the user |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True/False,
    "domain_name": ldap_domain_name,
    "user_dn": ldap_dn,
    "user_status": Enabled/Disabled
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  # Once the LDAP Utilities: Search completes, get the DN of the first entry
# which will be the DN of the account you want to set a Toggle Access for

inputs.ldap_domain_name = 'domain1'
inputs.ldap_dn = workflow.properties.search_output["entries"][0]["dn"]
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # If the function is successful in updating users access rights,
# a note is added to the incident

if (results.success):
  
  color = "#45bc27" #green
  
  if (results.user_status == "Disabled"):
    color = "#ff402b" #red
  
  noteText = """<br><i style="color: #979ca3">LDAP Utilities: Toggle Access workflow <u>complete</u>:</i>
                    <b>Email:</b> <u style="color: #7fb0ff">{0}</u>
                    <b>Status:</b> <b style="color: {1}">{2}</b>
                    <b>DN:</b> '{3}'""".format(artifact.value, color, results.user_status, results.user_dn)
  
  incident.addNote(helper.createRichText(noteText))
  ```

  </p>
  </details>

</details>

---
## Function - LDAP Utilities: Remove from Group(s)
<p>A function that allows you to remove multiple from multiple groups</p>
<p>Supports: Active Directory only</p>

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `ldap_domain_name` | `text` | Yes | `-` | A domain name as in app.config which the ldap action is executed. |
| `ldap_multiple_group_dn` | `text` | Yes | `"['dn=Accounts Group,dc=example,dc=com', 'dn=IT Group,dc=example,dc=com']"` | List (represented as a string) of each DN of the related groups |
| `ldap_multiple_user_dn` | `text` | Yes | `"['dn=tom smith,dc=example,dc=com', 'dn=ted smith,dc=example,dc=com']"` | List (represented as a string) of each DN of the users |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    "success": True/False,
    "domain_name": ldap_domain_name,
    "users_dn": users_dn if user was removed, otherwise None,
    "groups_dn": ldap_multiple_group_dn
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  # Both inputs must be a string representation of a List

## Example of multiple entries
# inputs.ldap_multiple_user_dn = "['dn=user1,dc=example,dc=com', 'dn=user2,dc=example,dc=com']"
# inputs.ldap_multiple_group_dn = "['dn=Accounts Group,dc=example,dc=com', 'dn=IT Group,dc=example,dc=com']"

## Note: You can use this handy function below, then not need to worry about the inputs formatting

def into_string_list_format(entries):
  """Function that converts a list or single string into a 'string repersentation of a list'"""
  string_list_to_return = "[{0}]"
  
  # If its a string, assume its one DN, one entry
  if isinstance(entries, basestring):
    return string_list_to_return.format('"{0}"'.format(entries))
  
  # Else assume its a List, so multiple DNs, multiple entries
  else:
    entries_to_add = ""
    for e in entries:
      entries_to_add += '"{0}",'.format(e)
    return string_list_to_return.format(entries_to_add)

list_of_users_dn = ['dn=user1,dc=example,dc=com', 'dn=user2,dc=example,dc=com']

# Both inputs must be a string representation of a List
inputs.ldap_multiple_user_dn = into_string_list_format(list_of_users_dn)
inputs.ldap_multiple_group_dn = into_string_list_format('dn=Accounts Group,dc=example,dc=com')
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  # If the function is successful in removing the users from said groups,
# a note is added to the incident

if (results.success):
  
  if (results.users_dn is None):
    noteText = """<br><i style="color: #979ca3">LDAP Utilities: Remove User from Group(s) <u>complete</u>:</i>
                  <b>No users found. Check inputted user DN's</b>"""
  
  else:
    noteText = """<br><i style="color: #979ca3">LDAP Utilities: Remove User from Group(s) <u>complete</u>:</i>
                    <b>User(s):</b> {0}
                    <b>Group(s):</b> {1}""".format(results.users_dn, results.groups_dn)
  
  incident.addNote(helper.createRichText(noteText))
  ```

  </p>
  </details>

</details>

---

## Data Table - LDAP Computers query results

#### API Name:
ldap_computers_query_results

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| DN | `dn` | `text` | - |
| Hostname | `hostname` | `text` | - |
| OS | `os` | `text` | - |
| Password last set | `password_last_set` | `text` | - |
| When created | `when_created` | `text` | - |

---
## Data Table - LDAP Users query results

#### API Name:
ldap_users_query_results

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| Username | `cn` | `text` | - |
| Department | `department` | `text` | - |
| Name | `displayName` | `text` | - |
| Email | `email_address` | `text` | - |
| Manager | `manager` | `text` | - |
| Password last set | `password_last_set` | `text` | - |
| Title | `title` | `text` | - |
| When created | `when_created` | `text` | - |

---



## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Example: LDAP Utilities: Search User | artifact | `example_ldap_utilities_search` |
| Example: LDAP Utilities: Update | artifact | `example_ldap_utilities_update` |
| Example: LDAP Utilities: Add User(s) to Group(s) | artifact | `example_ldap_utilities_add_users_to_groups` |
| Example: LDAP Utilities: Set Password | artifact | `example_ldap_utilities_set_password` |
| Example: LDAP Utilities: Toggle Access | artifact | `example_ldap_utilities_toggle_access` |
| Example: LDAP Utilities: Search Computer | artifact | `example_ldap_utilities_search_computer` |
| Example: LDAP Utilities: Remove User(s) from Group(s) | artifact | `example_ldap_utilities_remove_users_from_groups` |

---

<!--
## Inform Resilient Users
  Use this section to optionally provide additional information so that Resilient playbook 
  designer can get the maximum benefit of your integration.
-->